{% extends 'base.html' %}

{% block title %}System Reports - Admin{% endblock %}

{% block extra_css %}
<style>
  .reports-container { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
  .reports-header { background: #fff; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
  .reports-header h1 { color: #667eea; font-size: 2.5rem; font-weight: 700; margin: 0; text-align: center; }
  .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
  .stat-card { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: transform 0.3s ease; text-align: center; }
  .stat-card:hover { transform: translateY(-5px); }
  .stat-card.students { border-left: 5px solid #4CAF50; }
  .stat-card.rooms { border-left: 5px solid #2196F3; }
  .stat-card.occupied { border-left: 5px solid #FF5722; }
  .stat-card.available { border-left: 5px solid #00BCD4; }
  .stat-card.maintenance { border-left: 5px solid #FF9800; }
  .stat-card.complaints { border-left: 5px solid #E91E63; }
  .stat-card.payments { border-left: 5px solid #9C27B0; }
  .stat-card.pending { border-left: 5px solid #FFC107; }
  .stat-card h3 { font-size: 0.85rem; color: #666; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
  .stat-card .stat-value { font-size: 2.2rem; font-weight: 700; margin: 10px 0; }
  .stat-card.students .stat-value { color: #4CAF50; }
  .stat-card.rooms .stat-value { color: #2196F3; }
  .stat-card.occupied .stat-value { color: #FF5722; }
  .stat-card.available .stat-value { color: #00BCD4; }
  .stat-card.maintenance .stat-value { color: #FF9800; }
  .stat-card.complaints .stat-value { color: #E91E63; }
  .stat-card.payments .stat-value { color: #9C27B0; }
  .stat-card.pending .stat-value { color: #FFC107; }
  .stat-card .stat-subtitle { font-size: 0.8rem; color: #999; }
  .chart-container { background: #fff; padding: 40px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin: 0 auto 30px; max-width: 1200px; }
  .chart-container h2 { color: #667eea; font-size: 1.8rem; margin-bottom: 30px; text-align: center; font-weight: 700; }
  #overviewChart { max-height: 500px !important; }
</style>
{% endblock %}

{% block content %}
<div class="reports-container">
  <div class="reports-header">
    <h1>📊 System Reports & Analytics</h1>
  </div>

  <div class="stats-overview">
    <div class="stat-card students">
      <h3>👥 Total Students</h3>
      <div class="stat-value">{{ (stats.get('total_students', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Registered</div>
    </div>

    <div class="stat-card rooms">
      <h3>🏠 Total Rooms</h3>
      <div class="stat-value">{{ (stats.get('total_rooms', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">In System</div>
    </div>

    <div class="stat-card occupied">
      <h3>🔴 Occupied</h3>
      <div class="stat-value">{{ (stats.get('occupied_rooms', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Rooms With Students</div>
    </div>

    <div class="stat-card available">
      <h3>✅ Available</h3>
      <div class="stat-value">{{ (stats.get('available_rooms', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Vacant Rooms</div>
    </div>

    <div class="stat-card maintenance">
      <h3>🔧 Maintenance</h3>
      <div class="stat-value">{{ (stats.get('maintenance_rooms', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Under Maintenance</div>
    </div>

    <div class="stat-card complaints">
      <h3>📝 Complaints</h3>
      <div class="stat-value">{{ (stats.get('total_complaints', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Total Raised</div>
    </div>

    <div class="stat-card payments">
      <h3>💰 Revenue</h3>
      <div class="stat-value">₹{{ (stats.get('total_revenue', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Total Verified</div>
    </div>

    <div class="stat-card pending">
      <h3>⏳ Pending</h3>
      <div class="stat-value">{{ (stats.get('pending_payments', 0) if stats else 0) }}</div>
      <div class="stat-subtitle">Payments Awaiting</div>
    </div>
  </div>

  <div class="chart-container">
    <h2>📈 Complete System Overview</h2>
    <canvas id="overviewChart"></canvas>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Expecting Chart.js to be loaded globally (e.g., via base.html)
    const statsObj = {{ (stats|tojson) if stats else 'null' }};
    if (!statsObj || typeof window.Chart === 'undefined') return;

    // Number coercion with defaults
    const n = (k, d=0) => {
      const v = statsObj[k];
      return Number.isFinite(v) ? v : Number(v) || d;
    };

    // Map inbound stats to locals
    const data = {
      students: n('total_students'),
      totalRooms: n('total_rooms'),
      occupied: n('occupied_rooms'),
      available: n('available_rooms'),
      maintenance: n('maintenance_rooms'),
      totalComplaints: n('total_complaints'),
      pendingComplaints: n('pending_complaints'),
      resolvedComplaints: n('resolved_complaints'),
      verified: n('verified_payments'),
      pendingPayments: n('pending_payments'),
      revenue: n('total_revenue')
    };

    // Helper: return an array with value only in the desired category index, null elsewhere
    // Categories: 0=Students, 1=Room Status, 2=Complaints, 3=Payments
    const only = (idx, val) => [
      idx===0 ? val : null,
      idx===1 ? val : null,
      idx===2 ? val : null,
      idx===3 ? val : null
    ];

    // Plugin: draw a colored line on the x-axis only for true zero values
    const ZeroAxisMarks = {
      id: 'zeroAxisMarks',
      afterDatasetsDraw(chart) {
        const {ctx, scales} = chart;
        chart.data.datasets.forEach((ds) => {
          const meta = chart.getDatasetMeta(chart.data.datasets.indexOf(ds));
          const yScale = scales[ds.yAxisID || 'yLeft'];
          const yZero = yScale.getPixelForValue(0);

          meta.data.forEach((bar) => {
            const parsed = bar?.$context?.parsed;
            if (!parsed || !Number.isFinite(parsed.y)) return; // skip null/missing
            if (parsed.y !== 0) return;                        // only true zeros

            const w = bar.width ?? (bar.getProps ? bar.getProps(['width'], true).width : 10);
            const x = bar.x;
            ctx.save();
            ctx.strokeStyle = ds.borderColor || ds.backgroundColor;
            ctx.lineWidth = Math.max(3, Math.min(6, w * 0.16));
            ctx.beginPath();
            ctx.moveTo(x - w/2 + 1, yZero);
            ctx.lineTo(x + w/2 - 1, yZero);
            ctx.stroke();
            ctx.restore();
          });
        });
      }
    };

    const canvas = document.getElementById('overviewChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (canvas.__chart) canvas.__chart.destroy();

    canvas.__chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Students', 'Room Status', 'Complaints', 'Payments'],
        datasets: [
          // Students group
          { label: 'Total Students', data: only(0, data.students), backgroundColor: 'rgba(76,175,80,0.9)', borderColor: 'rgba(76,175,80,1)', yAxisID: 'yLeft' },

          // Room Status group
          { label: 'Occupied Rooms',    data: only(1, data.occupied),    backgroundColor: 'rgba(255,87,34,0.9)',  borderColor: 'rgba(255,87,34,1)',  yAxisID: 'yLeft' },
          { label: 'Available Rooms',   data: only(1, data.available),   backgroundColor: 'rgba(0,188,212,0.9)', borderColor: 'rgba(0,188,212,1)', yAxisID: 'yLeft' },
          { label: 'Maintenance Rooms', data: only(1, data.maintenance), backgroundColor: 'rgba(255,152,0,0.9)', borderColor: 'rgba(255,152,0,1)', yAxisID: 'yLeft' },

          // Complaints group
          { label: 'Total Complaints',    data: only(2, data.totalComplaints),   backgroundColor: 'rgba(233,30,99,0.9)', borderColor: 'rgba(233,30,99,1)', yAxisID: 'yLeft' },
          { label: 'Pending Complaints',  data: only(2, data.pendingComplaints), backgroundColor: 'rgba(255,193,7,0.9)', borderColor: 'rgba(255,193,7,1)', yAxisID: 'yLeft' },
          { label: 'Resolved Complaints', data: only(2, data.resolvedComplaints),backgroundColor: 'rgba(76,175,80,0.9)', borderColor: 'rgba(76,175,80,1)', yAxisID: 'yLeft' },

          // Payments group
          { label: 'Verified Payments', data: only(3, data.verified),        backgroundColor: 'rgba(156,39,176,0.9)', borderColor: 'rgba(156,39,176,1)', yAxisID: 'yLeft' },
          { label: 'Pending Payments',  data: only(3, data.pendingPayments), backgroundColor: 'rgba(255,193,7,0.9)',  borderColor: 'rgba(255,193,7,1)',  yAxisID: 'yLeft' },

          // Revenue on right axis
          { label: 'Total Revenue (₹)', data: only(3, data.revenue), backgroundColor: 'rgba(103,58,183,0.9)', borderColor: 'rgba(103,58,183,1)', yAxisID: 'yRight' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        // More edge space while keeping groups tight
        layout: { padding: { left: 80, right: 80, top: 8, bottom: 8 } },
        scales: {
          x: {
            type: 'category',
            offset: 'true',
            bounds: 'ticks',
            grid: {display: false},
            ticks: {color: '#333', maxRotation: 0, autoSkip: false}
          },
        },
        datasets: { bar: {
          categoryPercentage: 0.9,   // moderate inter-group spacing
          barPercentage: 0.98,       // bars nearly fill their slot
          borderWidth: 0,
          borderSkipped: false
        }},
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.dataset.yAxisID === 'yRight'
                ? `Revenue: ₹${Number(ctx.parsed.y).toLocaleString('en-IN')}`
                : `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          }
        },
        scales: {
          x: {
            type: 'category',
            offset: true, // half-category margins at both ends so bars don’t touch edges
            grid: { display: false },
            ticks: { color: '#333', maxRotation: 0, autoSkip: false }
          },
          yLeft: {
            type: 'linear',
            position: 'left',
            min: 0,
            max: 10,
            ticks: { stepSize: 1, color: '#333' },
            title: { display: true, text: 'Count' },
            grid: { color: 'rgba(0,0,0,0.08)' }
          },
          yRight: {
            type: 'linear',
            position: 'right',
            min: 0,
            max: 100000,
            ticks: {
              stepSize: 10000,
              callback: (v) => '₹' + Number(v).toLocaleString('en-IN'),
              color: '#673AB7'
            },
            title: { display: true, text: 'Revenue (₹)', color: '#673AB7' },
            grid: { drawOnChartArea: false }
          }
        }
      },
      plugins: [ZeroAxisMarks]
    });
  });
</script>
{% endblock %}

