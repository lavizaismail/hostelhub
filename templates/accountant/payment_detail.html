{% extends 'base.html' %}
{% block title %}Payment Verification{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-file-invoice-dollar text-primary"></i> 
                    Payment Verification
                </h2>
                <a href="{{ url_for('accountant.pending_payments') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            <!-- Main Card -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-circle"></i> 
                        {{ payment.student.fullname }}
                    </h4>
                    <small>Enrollment: {{ payment.student.enrollment_no }}</small>
                </div>

                <div class="card-body p-4">
                    <!-- Amount Section -->
                    <div class="text-center py-4 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px;">
                        <h5 class="text-white mb-2">Payment Amount</h5>
                        <h1 class="text-white mb-0">â‚¹{{ "{:,.2f}".format(payment.amount) }}</h1>
                    </div>

                    <!-- Payment Details -->
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-info-circle text-primary"></i> Payment Details
                    </h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Transaction ID</label>
                                <p class="fw-bold">{{ payment.transactionid or 'N/A' }}</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Bank Name</label>
                                <p class="fw-bold">{{ payment.bank_name or 'N/A' }}</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Payment Date</label>
                                <p class="fw-bold">
                                    {% if payment.payment_date %}
                                        {{ payment.payment_date.strftime('%d %B %Y') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Payment Time</label>
                                <p class="fw-bold">
                                    {% if payment.payment_time %}
                                        {{ payment.payment_time.strftime('%I:%M %p') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Payer Name</label>
                                <p class="fw-bold">{{ payment.payer_name or 'N/A' }}</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Submitted On</label>
                                <p class="fw-bold">{{ payment.created_at.strftime('%d %b %Y, %I:%M %p') }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Student Info -->
                    <h5 class="border-bottom pb-2 mb-3 mt-4">
                        <i class="fas fa-user text-primary"></i> Student Information
                    </h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Email</label>
                                <p class="fw-bold">{{ payment.student.user.email }}</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-box">
                                <label class="text-muted small">Phone</label>
                                <p class="fw-bold">{{ payment.student.phone or 'N/A' }}</p>
                            </div>
                        </div>

                        {% if allocation %}
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-door-open"></i>
                                <strong>Room Pending:</strong> {{ allocation.room.block }}-{{ allocation.room.roomnumber }}
                                ({{ allocation.room.room_type }})
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="row g-3 mt-4">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('accountant.verify_payment', payment_id=payment.paymentid) }}" 
                                  onsubmit="return confirm('Verify this payment and allocate room?')">
                                <button type="submit" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-check-circle"></i> Verify Payment
                                </button>
                            </form>
                        </div>

                        <div class="col-md-6">
                            <button type="button" class="btn btn-danger btn-lg w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                <i class="fas fa-times-circle"></i> Reject Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('accountant.reject_payment', payment_id=payment.paymentid) }}">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Reject Payment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Please provide a reason for rejecting this payment:</p>
                    <textarea name="reason" class="form-control" rows="4" required
                              placeholder="E.g., Invalid transaction ID, incorrect amount, etc."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Reject
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.detail-box {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.detail-box label {
    margin-bottom: 5px;
    display: block;
    font-size: 0.85rem;
}

.detail-box p {
    margin: 0;
    font-size: 1rem;
}

.card {
    border-radius: 15px !important;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}
</style>
{% endblock %}
